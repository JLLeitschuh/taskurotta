# Автоматическое тестирование 

Все добавления в репозиторий должны быть предварительно протестированы на автотесте. Для того чтобы запустить тест 
необходимо иметь установленный docker >= 1.8.3 и docker-compose >= 1.5.0rc1

Артефакты автотеста находятся в директории проекта autotest. Структура каталога:

- data/ - директория содержит оперативные данные, которые не нужно хранить в git. В ней в соответствующих каталогах 
будут располагаться логи и файлы базы данных
- etc/ - директория содержит конфигурационные файлы, необходимые для приложений участвующих в автотесте
- docker-compose.yml - декларативное описание участвующих в автотесте приложений
- docker.txt - пример запуска приложений в контейнере без docker-compose
- test.sh - утилита облегчающая работу с автотестом

## Конфигурация и цель автотеста

Автотест проходит на кластере taskurotta с двумя узлами. Кластер работает с mongodb. Oracle не используется (позже 
надо добавить в тест контейнер с oracle express). Балансировкой нагрузки занимается nginx. Приложение актеров 
подключается к кластеру через веб сервер. Отдельное приложение pusher запускается в последнем контейнере. Задача 
этого приложения стартануть 50_000 процессов в кластере и дождаться их выполнения. После чего оно завершает свою 
работу с соответствующей записью в лог.

Для эмуляции реальных условий актеры периодически теряют задачи и задерживают их более допустимого таймаута. Процесс 
восстановления taskurotta должен отслеживать такие ситуации и ставить задачи повторно в очередь на выполнение. Так-же
сервер отслеживает и не допускает обработку дублей результатов выполнения задач которые могут возникнуть в случае 
задержки ответов от актеров.
 
Положительное прохождение теста считается при достижении следующих условий:

- приложение pusher отправило все 50_000 процессов и дождалось их выполнения. Сейчас оно не пишет в лог о том что 
отправило все 50_000 - это надо добавить, но ждет и завершается когда все процессы станут выполнены)
- отсутствие в серверов taskurotta и актеров ошибок.

PS: Сейчас могут быть следующие ошибки, на которые не надо обращать внимание:

- ошибки о недоступности серверов на ранней стадии теста. Появляются ошибки у актера и pusher когда еще не стартанули
 nginx и\или кластер
- еще есть пара. Надо их сюда дописать или лучше подавить ибо не надо на них обращать внимание

## Работа с тестом

Все команды выполняются в директории autotest

    cd autotest
    
Для начала надо подтянуть в локальный репозиторий необходимые образы docker контейнеров. Это может занять 
продолжительное время в первый раз. Загружается примерно 1,3 гигабайта для трех образов Java, mongodb и nginx. 
Выполняем команду:

    ./test.sh build
    
Далее мы готовы запустить тест. Для начала выполняем команду для копирования собранного jar файла проекта (да, проект
должен быть предварительно собран). Jar файл копируется из директории assemble/бла_бла в директорию data/jar. Там 
его ожидают настройки монтирования директорий docker
 
    ./test.sh jar
    
Теперь можно запускать тест:
 
    docker-compose up -d
    
Смотрим соответствующие логи в data/* . По окончании теста можно остановить контейнеры:

    docker-compose stop
    
После проведения теста можно подчистить за ним. Удалить все не остановленные контейнеры:
    
    ./test.sh clean-docker
    
Удалить все файлы созданные во время теста (логи, бд и т.д.):

    ./test.sh clean-data
    
Или удалить все разом:

    ./test.sh clean
    
Команды можно комбинировать. Например очистить все и скопировать новый jar для теста

    ./test.sh clean jar
