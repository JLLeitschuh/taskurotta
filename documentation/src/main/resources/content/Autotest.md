# Автоматическое тестирование 

Все добавления в репозиторий должны быть предварительно протестированы на автотесте. Для того чтобы запустить тест 
необходимо иметь установленный docker >= 1.8.3

Артефакты автотеста находятся в директории проекта autotest. Структура каталога:

- data/ - директория содержит оперативные данные, которые не нужно хранить в git. В ней в соответствующих каталогах 
будут располагаться логи и файлы базы данных
- invertories - директория содержит файл описание серверов (контейнеров) участвующих в тесте и их роли
- roles/ - директория содержит скрипты ansible для каждого типа серверов
- test.sh - утилита облегчающая работу с автотестом

## Конфигурация и цель автотеста

Автотест проходит на кластере taskurotta с двумя узлами. Кластер работает с mongodb. Oracle не используется (позже 
надо добавить в тест контейнер с oracle express). Балансировкой нагрузки занимается nginx. Приложение актеров 
подключается к кластеру через веб сервер. Отдельное приложение pusher запускается в последнем контейнере. Задача 
этого приложения стартануть 50_000 процессов в кластере и дождаться их выполнения. После чего оно завершает свою 
работу с соответствующей записью в лог.

Для эмуляции реальных условий актеры периодически теряют задачи и задерживают их более допустимого таймаута. Процесс 
восстановления taskurotta должен отслеживать такие ситуации и ставить задачи повторно в очередь на выполнение. Так-же
сервер отслеживает и не допускает обработку дублей результатов выполнения задач которые могут возникнуть в случае 
задержки ответов от актеров.
 
Положительное прохождение теста считается при достижении следующих условий:

- приложение pusher отправило все 50_000 процессов и дождалось их выполнения. Сейчас оно не пишет в лог о том что 
отправило все 50_000 - это надо добавить, но ждет и завершается когда все процессы станут выполнены)
- отсутствие в серверов taskurotta и актеров ошибок.

PS: Сейчас могут быть следующие ошибки, на которые не надо обращать внимание:

- есть пара. Надо их сюда дописать или лучше подавить ибо не надо на них обращать внимание

## Работа с тестом

Все команды выполняются в директории autotest

    cd autotest
    
Для начала надо подтянуть в локальный репозиторий необходимые образы docker контейнеров. Это может занять 
продолжительное время в первый раз. Загружается примерно 1,3 гигабайта для трех образов Java, mongodb и nginx. 
Выполняем команду:

    ./test.sh prepare
    
Далее мы готовы запустить тест. Используется jar файл проекта из директории assemble/target (т.е., проект
должен быть предварительно собран).
 
    ./test.sh start
    
    
Смотрим соответствующие логи в data/* . Для отслеживани сообщений об ошибках на серверах и статистики актеров и 
приложения pusher можно запустить команду:

    ./test.sh tail
    
После проведения теста можно можно остановить все контейнеры:
    
    ./test.sh stop
    
После анализа логов можно удалить все созданные тестом файлы и контейнеры. Команду можно выполнять на работающем тесте:

    ./test.sh clean
    
