# Автоматическое тестирование 

Все добавления в репозиторий должны быть предварительно протестированы на автотесте. Для того чтобы запустить тест 
необходимо иметь установленный docker = 1.9 и Ansible = 1.9.4

Артефакты автотеста находятся в директории проекта autotest. Структура каталога:

- data/ - директория содержит оперативные данные, которые не нужно хранить в git. В ней в соответствующих каталогах 
будут располагаться логи и файлы базы данных
- invertories - директория содержит файл описание серверов (контейнеров) участвующих в тесте и их роли
- roles/ - директория содержит скрипты ansible для каждого типа серверов
- test.sh - утилита облегчающая работу с автотестом

## Конфигурация и цель автотеста

Автотест проходит на кластере taskurotta с двумя узлами. Кластер работает с mongodb. Oracle не используется (позже 
надо добавить в тест контейнер с oracle express). Балансировкой нагрузки занимается nginx. Приложение актеров 
подключается к кластеру через веб сервер. Отдельное приложение pusher запускается в последнем контейнере. Задача 
этого приложения стартануть 50_000 процессов в кластере и дождаться их выполнения. После чего оно завершает свою 
работу с соответствующей записью в лог.

Для эмуляции реальных условий актеры периодически теряют задачи и задерживают их более допустимого таймаута. Процесс 
восстановления taskurotta должен отслеживать такие ситуации и ставить задачи повторно в очередь на выполнение. Так-же
сервер отслеживает и не допускает обработку дублей результатов выполнения задач которые могут возникнуть в случае 
задержки ответов от актеров.
 
Положительное прохождение теста считается при достижении следующих условий:

- приложение pusher отправило все 50_000 процессов и дождалось их выполнения. Сейчас оно не пишет в лог о том что 
отправило все 50_000 - это надо добавить, но ждет и завершается когда все процессы станут выполнены)
- отсутствие в серверов taskurotta и актеров ошибок.

## Работа с тестом

Все команды выполняются в директории autotest

    cd autotest
    
Для начала надо подтянуть в локальный репозиторий необходимые образы docker контейнеров. Это может занять 
продолжительное время в первый раз. Загружается примерно 1,3 гигабайта для трех образов Java, mongodb и nginx. 
Выполняем команду:

    ./test.sh prepare
    
Далее мы готовы запустить тест. Используется jar файл проекта из директории assemble/target (т.е., проект
должен быть предварительно собран).
 
    ./test.sh start
    
Смотрим соответствующие логи в data/* . Для отслеживани сообщений об ошибках на серверах и статистики актеров и 
приложения pusher можно запустить команду:

    ./test.sh tail
    
После проведения теста можно можно остановить все контейнеры:
    
    ./test.sh stop
    
После анализа логов можно удалить все созданные тестом файлы и контейнеры. Команду можно выполнять на работающем тесте:

    ./test.sh clean
    
Для того чтобы не править конфиги и не путаться потом что комитить в репозиторий а что нет, можно переопределять 
некоторые свойства сценариев в файле extra_vars.json. Его необходимо создать в директории autotest. 
Этот файл добавлен в список игнорируемых для git. Например файл такого содержания:

    {
      "mongodb_path": "/tmp/tsk_mongodb",
      "ff_actors_config": "{{ lookup('pipe', 'find $(pwd) -name config-speed.yml') }}"
    }

переопределяет путь для артефактов mongodb и испульзуемый актерами конфиг. В данном случае используется ansible lookup 
для получения полного пути для файла config-speed.yml лежащего в role актеров. Можно использовать свой файл и 
соответственносвой полный путь до него.

## Особенности окружения при тестировании

Для обеспечения строгой проверки завершения всех процессов, добавлен механизм сохранения всех успешно 
завершенных customId процессов в отдельную коллекцию mongodb. Имя коллекции "finishedProcess". Включается этот 
механизм только при наличии следующего ключа при старте сервера:

    -Dru.taskurotta.service.hz.storage.saveFinishedProcessCustomId=true
    
В этой коллекции каждый документ хранит идентификатор customId завершенного процесса и сколько раз он завершился. 
Приложение которое запускает процессы и отслеживает их завершение (ProcessPusher) теперь получает информацию о 
количестве завершенных процессов из этой коллекции mongodb. По завершении всех процессов происходит поиск не 
завершенных процессов по этой коллекции. В случае обнаружения в лог пишется ошибка. Так-же проверяется что такой 
процесс завершился только один раз. Если больше - в лог добавляется предупреждение.