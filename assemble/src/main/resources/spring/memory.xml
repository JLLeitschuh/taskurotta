<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <context:property-placeholder/>
    <context:annotation-config/>

    <!-- REST resources -->
    <bean id="taskPullerResource" class="ru.taskurotta.dropwizard.resources.TaskPollerResource">
        <property name="taskServer" ref="taskServer"/>
    </bean>
    <bean id="taskReleaserResource" class="ru.taskurotta.dropwizard.resources.TaskReleaserResource">
        <property name="taskServer" ref="taskServer"/>
    </bean>
    <bean id="taskStarterResource" class="ru.taskurotta.dropwizard.resources.TaskStarterResource">
        <property name="taskServer" ref="taskServer"/>
    </bean>
    <!-- /REST resources -->

    <bean id="taskServer" class="ru.taskurotta.server.GeneralTaskServer">
        <constructor-arg name="configService" ref="configService"/>
        <constructor-arg name="dependencyService" ref="dependencyService"/>
        <constructor-arg name="processService" ref="processService"/>
        <constructor-arg name="queueService" ref="queueService"/>
        <constructor-arg name="taskService" ref="taskService"/>
        <constructor-arg name="brokenProcessService" ref="brokenProcessService" />
        <constructor-arg name="garbageCollectorService" ref="garbageCollectorService"/>
    </bean>

    <!-- Backends -->
    <bean id="queueService" class="ru.taskurotta.service.queue.MemoryQueueService">
        <constructor-arg name="pollDelay">
            <bean class="ru.taskurotta.util.DurationParser" factory-method="toMillis">
                <constructor-arg name="duration" value="${server.poll-delay}"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="taskDao" class="ru.taskurotta.service.storage.MemoryTaskDao" />

    <bean id="taskService" class="ru.taskurotta.service.storage.GeneralTaskService">
        <constructor-arg name="taskDao" ref="taskDao" />
    </bean>
    <bean id="dependencyService" class="ru.taskurotta.service.dependency.GeneralDependencyService">
        <constructor-arg name="graphDao" ref="graphDao" />
    </bean>

    <bean id="brokenProcessService" class="ru.taskurotta.service.storage.MemoryBrokenProcessService" />

    <bean id="graphDao" class="ru.taskurotta.service.dependency.links.MemoryGraphDao" />

    <bean id="processService" class="ru.taskurotta.service.storage.MemoryProcessService" />

    <bean id="configService" class="ru.taskurotta.service.config.impl.MemoryConfigService" />

    <bean id="recoveryProcessService" class="ru.taskurotta.service.recovery.GeneralRecoveryProcessService">
        <constructor-arg name="dependencyService" ref="dependencyService"/>
        <constructor-arg name="processService" ref="processService"/>
        <constructor-arg name="queueService" ref="queueService"/>
        <constructor-arg name="taskService" ref="taskService"/>
        <constructor-arg name="taskDao" ref="taskDao"/>
        <constructor-arg name="brokenProcessService" ref="brokenProcessService"/>
        <constructor-arg name="garbageCollectorService" ref="garbageCollectorService"/>
        <constructor-arg name="recoveryProcessChangeTimeout">
            <bean class="ru.taskurotta.util.DurationParser" factory-method="toMillis">
                <constructor-arg name="duration" value="${recovery.process.change-timeout}"/>
            </bean>
        </constructor-arg>
        <constructor-arg name="findIncompleteProcessPeriod">
            <bean class="ru.taskurotta.util.DurationParser" factory-method="toMillis">
                <constructor-arg name="duration" value="${recovery.find-incomplete-process-period}"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="garbageCollectorService" class="ru.taskurotta.service.gc.MemoryGarbageCollectorService">
        <constructor-arg name="processService" ref="processService"/>
        <constructor-arg name="graphDao" ref="graphDao"/>
        <constructor-arg name="taskDao" ref="taskDao"/>
        <constructor-arg name="poolSize" value="${gc.pool-size}"/>
        <constructor-arg name="timeBeforeDelete">
            <bean class="ru.taskurotta.util.DurationParser" factory-method="toMillis">
                <constructor-arg name="duration" value="${gc.time-before-delete}"/>
            </bean>
        </constructor-arg>
    </bean>
    <!-- /Backends -->

    <bean id="checkTaskServer" class="ru.taskurotta.dropwizard.health.CheckTaskServer">
        <constructor-arg name="name" value="check task server" />
        <property name="taskServer" ref="taskServer" />
    </bean>

    <bean id="metricsDataHandler" class="ru.taskurotta.service.metrics.handler.MetricsDataHandler" init-method="init" />
    <bean id="metricsNumberDataHandler" class="ru.taskurotta.service.metrics.handler.NumberDataHandler" init-method="init" />

</beans>