<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:hz="http://www.hazelcast.com/schema/spring"
       xmlns:mongo="http://www.springframework.org/schema/data/mongo"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
            http://www.hazelcast.com/schema/spring http://www.hazelcast.com/schema/spring/hazelcast-spring-3.1.xsd
            http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
            http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
            http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.1.xsd
            ">

    <bean id = "actorListResource" class = "ru.taskurotta.dropwizard.resources.console.actors.ActorListResource">
        <property name="actorConfigManager" ref="actorConfigManager"/>
        <property name="configBackend" ref="configBackend"/>
    </bean>

    <bean id="actorCompareResource" class="ru.taskurotta.dropwizard.resources.console.actors.ActorCompareResource">
        <property name="metricsDataRetriever" ref="metricsDataHandler"/>
        <property name="actorConfigManager" ref="actorConfigManager"/>
    </bean>

    <bean id="baseConsoleResource" class="ru.taskurotta.dropwizard.resources.console.BaseResource">
        <property name="consoleManager" ref="consoleManager"/>
    </bean>
    <bean id="consoleQueueListResource" class="ru.taskurotta.dropwizard.resources.console.queue.QueueStatListResource" parent="baseConsoleResource">
        <property name = "queueInfoRetriever" ref = "realQueueBackend" />
    </bean>
    <bean id="consoleQueueCardResource" class="ru.taskurotta.dropwizard.resources.console.QueueContentResource" parent="baseConsoleResource"/>
    <bean id="consoleTaskCardResource" class="ru.taskurotta.dropwizard.resources.console.process.TaskResource" parent="baseConsoleResource"/>
    <bean id="consoleTaskListResource" class="ru.taskurotta.dropwizard.resources.console.process.TaskListResource" parent="baseConsoleResource"/>
    <bean id="consoleProcessCardResource" class="ru.taskurotta.dropwizard.resources.console.process.ProcessResource" parent="baseConsoleResource"/>
    <bean id="consoleProcessListResource" class="ru.taskurotta.dropwizard.resources.console.process.ProcessListResource" parent="baseConsoleResource"/>
    <bean id="consoleProcessTaskResource" class="ru.taskurotta.dropwizard.resources.console.process.ProcessTaskResource" parent="baseConsoleResource"/>
    <bean id="consoleTaskTreeResource" class="ru.taskurotta.dropwizard.resources.console.process.TaskTreeResource" parent="baseConsoleResource"/>

    <bean id="consoleProcessSearchResource" class="ru.taskurotta.dropwizard.resources.console.process.ProcessSearchResource" parent="baseConsoleResource"/>
    <bean id="consoleTaskSearchResource" class="ru.taskurotta.dropwizard.resources.console.process.TaskSearchResource" parent="baseConsoleResource"/>

    <bean id="hoveringQueuesResource" class="ru.taskurotta.dropwizard.resources.console.HoveringQueuesResource" parent="baseConsoleResource"/>
    <bean id="repeatedTasks" class="ru.taskurotta.dropwizard.resources.console.RepeatedTasksResource" parent="baseConsoleResource"/>
    <bean id="consoleTaskDecisionResource" class="ru.taskurotta.dropwizard.resources.console.process.TaskDecisionResource" parent="baseConsoleResource" />

    <bean id="consoleMetricsResource" class="ru.taskurotta.dropwizard.resources.console.metrics.MetricsResource" parent="baseConsoleResource" >
        <property name="metricsDataHandler" ref="consoleMetricsDataHandler" />
        <property name="metricsOptionsHandler" ref="consoleMetricsOptionsHandler" />
    </bean>

    <bean id="consoleMetricsDataHandler" class="ru.taskurotta.dropwizard.resources.console.metrics.MetricsDataProvider">
        <property name="methodDataRetriever" ref="metricsDataHandler" />
        <property name="numberDataRetriever" ref="metricsNumberDataHandler" />
        <property name="methodMetricsPeriodSeconds" value = "${metric.method.data.period.seconds}" />
        <property name="numberMetricsPeriodSeconds" value = "${metric.queue.size.data.period.seconds}" />
    </bean>

    <bean id = "consoleMetricsOptionsHandler" class="ru.taskurotta.dropwizard.resources.console.metrics.MetricsOptionsProvider" >
        <property name="methodDataRetriever" ref="metricsDataHandler" />
        <property name="numberDataRetriever" ref="metricsNumberDataHandler" />
        <property name="optionsSupportBean" ref="optionsSupportBean" />
    </bean>

    <bean id="optionsSupportBean" class="ru.taskurotta.dropwizard.resources.console.metrics.support.OptionsSupportBean" >

        <property name="metricsDescription">
            <map>
                <entry key="startProcess" value="TaskServer#startProcess method invocations" />
                <entry key="poll" value="TaskServer#poll method invocations" />
                <entry key="successfulPoll" value="TaskServer#poll method invocations (with not empty polled task)" />
                <entry key="release" value="TaskServer#release method invocations" />
                <entry key="executionTime" value="Actor mean execution time (ms)" />
                <entry key="errorDecision" value="Actor with error decision mean execution time (ms)" />
                <entry key="enqueue" value="QueueBackend#enqueueTask method invocation" />
                <entry key="queueSize" value="Number of tasks in the queue" />
            </map>
        </property>

        <property name="datasetDescription">
            <map>
                <entry key="startProcess#startProcess" value="Mean value for method invocation by all actors" />
                <entry key="poll#poll" value="Mean value for method invocation by all actors" />
                <entry key="successfulPoll#successfulPoll" value="Mean value for method invocation by all actors" />
                <entry key="release#release" value="Mean value for method invocation by all actors" />
                <entry key="executionTime#executionTime" value="Mean value for all actors" />
                <entry key="errorDecision#errorDecision" value="Mean value for all actors" />
                <entry key="enqueue#enqueue" value="QueueBackend#enqueueTask method invocation" />
                <entry key="queueSize#queueSize" value="Total number of task for all queues" />
            </map>
        </property>

        <property name="defaultDataTypes" value = "rate, mean" />

        <property name="defaultPeriods" value = "hour, day" />

        <property name="defaultScopes" value = "local" />

        <property name="metricDataTypes">
            <map>
                <entry key="queueSize" value="items" />
            </map>
        </property>
        <property name="metricPeriods">
            <map>
                <entry key="queueSize" value="day, hour, 5minutes" />
            </map>
        </property>
        <property name="metricScopes">
            <map>
                <entry key="queueSize" value = "cluster" />
            </map>
        </property>

        <property name="optionDescriptions">
            <map>
                <entry key="day" value="Last 24 hours" />
                <entry key="hour" value="Last hour" />
                <entry key="cluster" value="All nodes (cluster)" />
                <entry key="local" value="Current node" />
                <entry key="5minutes" value="Last 5 minutes" />
                <entry key="rate" value="Hits (times)" />
                <entry key="mean" value="Mean time (ms)" />
                <entry key="items" value="Number of items" />
            </map>
        </property>

    </bean>

    <bean id="brokenProcessListResource" class="ru.taskurotta.dropwizard.resources.console.broken.BrokenProcessListResource" >
        <constructor-arg name="recoveryThreads" value="${broken.process.recovery.threads}" />

        <property name="brokenProcessBackend" ref="brokenProcessBackend" />
        <property name="recoveryProcessBackend" ref="recoveryProcessBackend" />
    </bean>

    <bean id="consoleManager" class="ru.taskurotta.backend.console.manager.impl.ConsoleManagerImpl">
        <property name="queueInfo" ref="realQueueBackend"/>
        <property name="taskInfo" ref="taskBackend"/>
        <property name="processInfo" ref="processBackend"/>
        <property name="graphInfo" ref="dependencyBackend"/>
    </bean>

</beans>