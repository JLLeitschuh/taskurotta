<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:task="http://www.springframework.org/schema/task"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
            http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd">

    <context:property-placeholder />

    <bean id="clientServiceManager" class="ru.taskurotta.client.memory.ClientServiceManagerMemory">
        <constructor-arg name="pollDelay" value="3" />
    </bean>

    <bean id="taskCreator" class="ru.taskurotta.recipes.summator.TaskCreator" init-method="createStartTask">
        <property name="clientServiceManager" ref="clientServiceManager" />
        <property name="arraySize" value="${array_size}"/>
    </bean>

    <bean id="queueBackend" factory-bean="clientServiceManager"
        factory-method="getQueueBackend" />
    <bean id="taskBackend" factory-bean="clientServiceManager"
        factory-method="getTaskBackend" />
    <bean id="configBackend" factory-bean="clientServiceManager"
        factory-method="getConfigBackend" />

    <bean id="taskExpirationRecovery" class="ru.taskurotta.server.recovery.RetryEnqueueRecovery">
        <property name="queueBackend" ref="queueBackend" />
        <property name="taskBackend" ref="taskBackend" />
        <property name="configBackend" ref="configBackend" />
        <property name="recoveryPeriod" value="86400" />
        <property name="recoveryPeriodUnit" value="SECONDS" />
        <property name="timeIterationStep" value="1000" />
        <property name="timeIterationStepUnit" value="MILLISECONDS" />
        <property name="supportedTimeouts">
            <array value-type="ru.taskurotta.backend.checkpoint.TimeoutType">
                <value>TASK_START_TO_CLOSE</value>
                <value>TASK_POLL_TO_COMMIT</value>
            </array>
        </property>
    </bean>

    <task:scheduled-tasks scheduler="taskExpirationRecoveryScheduler">
        <task:scheduled ref="taskExpirationRecovery" method="run" cron="*/2 * * * * ?"/>
    </task:scheduled-tasks>
    <task:scheduler id="taskExpirationRecoveryScheduler" pool-size="1" />

</beans>
